# =============================================================================
# BookVerse Platform - Service Repository Secrets and Variables Configuration
# =============================================================================
#
# This workflow automates the configuration of required secrets and variables
# across all BookVerse service repositories, enabling CI/CD workflows to
# authenticate with JFrog Platform and perform evidence collection.
#
# ðŸŽ¯ PURPOSE:
#     Automated configuration of GitHub repository secrets and variables for
#     all BookVerse service repositories, ensuring consistent CI/CD setup
#     across the entire platform.
#
# ðŸš€ KEY FEATURES:
#     - Automated repository variables configuration (JFROG_URL, JF_PROJECT, DOCKER_REGISTRY, EVIDENCE_KEY_ALIAS)
#     - Automated repository secrets configuration (EVIDENCE_PRIVATE_KEY)
#     - Optional GitHub repository dispatch token configuration for platform orchestration
#     - Batch processing across all service repositories
#     - Comprehensive error handling and status reporting
#
# ðŸ“‹ REQUIRED REPOSITORY SECRETS:
#     - JFROG_URL: JFrog Platform URL (e.g., "https://your-instance.jfrog.io")
#     - EVIDENCE_KEY_ALIAS: Evidence signing key alias in JFrog Platform
#     - EVIDENCE_PRIVATE_KEY: Private key for evidence signing (PEM format)
#     - GH_ORG: GitHub organization/owner name (e.g., "yonatanp-jfrog")
#
# ðŸ“‹ OPTIONAL REPOSITORY SECRETS:
#     - JF_PROJECT: JFrog project key (defaults to "bookverse" if not provided)
#     - DOCKER_REGISTRY: Docker registry hostname (derived from JFROG_URL if not provided)
#     - GH_REPO_DISPATCH_TOKEN: GitHub PAT for cross-repository workflow triggering
#
# Authors: BookVerse Platform Team
# Version: 1.0.0
# =============================================================================

name: ðŸ”§ Configure Service Secrets

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  configure-secrets:
    name: Configure Service Repository Secrets & Variables
    runs-on: ubuntu-latest
    
    
    steps:
      - name: "[Setup] Checkout"
        uses: actions/checkout@v4
      
      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh auth login
          gh auth status
      
      - name: "[Validate] Required Secrets"
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ vars.JFROG_URL }}" ]; then
            MISSING_SECRETS+=("JFROG_URL")
          fi
          
          if [ -z "${{ secrets.EVIDENCE_KEY_ALIAS }}" ]; then
            MISSING_SECRETS+=("EVIDENCE_KEY_ALIAS")
          fi
          
          if [ -z "${{ secrets.EVIDENCE_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("EVIDENCE_PRIVATE_KEY")
          fi
          
          if [ -z "${{ vars.GH_ORG }}" ]; then
            MISSING_SECRETS+=("GH_ORG")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required repository secrets: ${MISSING_SECRETS[*]}"
            echo ""
            echo "ðŸ“‹ Required Repository Secrets:"
            echo "  - JFROG_URL: JFrog Platform URL"
            echo "  - EVIDENCE_KEY_ALIAS: Evidence signing key alias"
            echo "  - EVIDENCE_PRIVATE_KEY: Private key for evidence signing (PEM format)"
            echo "  - GH_ORG: GitHub organization/owner name (repository variable)"
            echo ""
            echo "ðŸ“‹ Optional Repository Secrets:"
            echo "  - JF_PROJECT: JFrog project key (defaults to 'bookverse')"
            echo "  - DOCKER_REGISTRY: Docker registry hostname (derived from JFROG_URL if not provided)"
            echo "  - GH_REPO_DISPATCH_TOKEN: GitHub PAT for cross-repository workflow triggering"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
      
      - name: "[Configure] Service Repository Secrets & Variables"
        env:
          # Required secrets
          JFROG_URL: ${{ vars.JFROG_URL }}
          EVIDENCE_KEY_ALIAS: ${{ secrets.EVIDENCE_KEY_ALIAS }}
          EVIDENCE_PRIVATE_KEY: ${{ secrets.EVIDENCE_PRIVATE_KEY }}
          GH_ORG: ${{ vars.GH_ORG }}
          
          # Optional secrets (with defaults)
          JF_PROJECT: ${{ vars.JF_PROJECT || 'bookverse' }}
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          GH_REPO_DISPATCH_TOKEN: ${{ secrets.GH_REPO_DISPATCH_TOKEN }}
        run: |
          chmod +x .github/scripts/setup/configure_service_secrets.sh
          .github/scripts/setup/configure_service_secrets.sh "$GH_ORG"
      
      - name: "[Summary] Configuration Complete"
        if: always()
        run: |
          echo "## ðŸ”§ Service Secrets Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Configuration workflow completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Configured repositories:" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-inventory" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-checkout" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-platform" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-web" >> $GITHUB_STEP_SUMMARY
          echo "- bookverse-helm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify configuration by checking repository variables and secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Test CI/CD workflows on any service repository" >> $GITHUB_STEP_SUMMARY
          echo "3. Validate evidence collection and signing" >> $GITHUB_STEP_SUMMARY


name: 'ðŸ”„ Switch Platform'

on:
  workflow_dispatch:
    inputs:
      setup_mode:
        description: 'Operation mode: initial_setup (first-time setup) or platform_switch (migrate/refresh)'
        required: true
        type: choice
        options:
          - initial_setup
          - platform_switch
        default: 'platform_switch'
      jpd_host:
        description: 'JFrog Platform Host (e.g., https://mycompany.jfrog.io)'
        required: true
        type: string
      admin_token:
        description: 'JFrog Admin Token for the new platform (optional if JFROG_ADMIN_TOKEN secret is set)'
        required: false
        type: string
      confirm_switch:
        description: 'Type "SWITCH" to confirm (required for platform_switch mode)'
        required: false
        type: string
      generate_evidence_keys:
        description: 'Generate new evidence keys if not present (recommended for initial_setup)'
        required: false
        type: boolean
        default: true
      evidence_key_type:
        description: 'Evidence key algorithm (rsa, ec, ed25519)'
        required: false
        type: choice
        options:
          - rsa
          - ec
          - ed25519
        default: 'rsa'
      evidence_key_alias:
        description: 'Evidence key alias (default: bookverse-signing-key)'
        required: false
        type: string
        default: 'bookverse-signing-key'
      update_code_urls:
        description: 'Update hardcoded URLs in source code (skip for initial_setup)'
        required: false
        type: boolean
        default: true
      update_k8s:
        description: 'Update Kubernetes cluster registry (requires kubectl access)'
        required: false
        type: boolean
        default: false

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

concurrency:
  group: switch-platform-${{ github.ref }}
  cancel-in-progress: true

jobs:
  switch-platform:
    runs-on: ubuntu-latest
    name: Switch Platform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

        
      - name: Setup JFrog CLI
        uses: EyalDelarea/setup-jfrog-cli@swampUpAppTrust
        with:
          version: latest
          
      - name: Validate Confirmation
        run: |
          SETUP_MODE="${{ github.event.inputs.setup_mode }}"
          if [[ "$SETUP_MODE" == "platform_switch" ]]; then
            if [[ "${{ github.event.inputs.confirm_switch }}" != "SWITCH" ]]; then
              echo "âŒ Platform switch cancelled: Invalid confirmation input"
              echo "   You must type 'SWITCH' to confirm platform migration"
              exit 1
            fi
            echo "âœ… Platform switch confirmed. Proceeding with platform migration..."
          else
            echo "âœ… Initial setup mode detected. Skipping migration confirmation."
          fi

      - name: Mask sensitive inputs
        run: |
          if [[ -n "${{ github.event.inputs.admin_token }}" ]]; then
            echo "::add-mask::${{ github.event.inputs.admin_token }}"
          fi
          if [[ -n "${{ secrets.JFROG_ADMIN_TOKEN }}" ]]; then
            echo "::add-mask::${{ secrets.JFROG_ADMIN_TOKEN }}"
          fi
          
      - name: Switch/Setup JFrog Platform
        run: |
          export NEW_JFROG_URL='${{ github.event.inputs.jpd_host }}'
          export SETUP_MODE='${{ github.event.inputs.setup_mode }}'
          export GENERATE_EVIDENCE_KEYS='${{ github.event.inputs.generate_evidence_keys }}'
          export EVIDENCE_KEY_TYPE='${{ github.event.inputs.evidence_key_type }}'
          export EVIDENCE_KEY_ALIAS='${{ github.event.inputs.evidence_key_alias }}'
          export UPDATE_CODE_URLS='${{ github.event.inputs.update_code_urls }}'
          
          if [[ -n "${{ github.event.inputs.admin_token }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ github.event.inputs.admin_token }}'
            echo "ðŸ” Using admin_token from workflow input"
          elif [[ -n "${{ secrets.JFROG_ADMIN_TOKEN }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ secrets.JFROG_ADMIN_TOKEN }}'
            echo "ðŸ” Using JFROG_ADMIN_TOKEN from repository secrets"
          else
            echo "âŒ No JFROG_ADMIN_TOKEN found in secrets or workflow inputs"
            exit 1
          fi
          export NO_COLOR=1
          LOG_FILE="switch-platform.log"
          echo "LOG_FILE=$LOG_FILE" >> "$GITHUB_ENV"
          
          if [[ "$SETUP_MODE" == "initial_setup" ]]; then
            echo "ðŸš€ Starting Initial Platform Setup"
            echo "=================================================="
            echo "Mode: Initial Setup (first-time configuration)"
            echo "Target Platform: ${{ github.event.inputs.jpd_host }}"
            echo "Generate Evidence Keys: $GENERATE_EVIDENCE_KEYS"
            echo ""
          else
            echo "ðŸ”„ Starting JFrog Platform Switch"
            echo "=================================================="
            if [[ -z "${{ vars.JFROG_URL }}" ]]; then
              echo "âš ï¸  Missing vars.JFROG_URL. Treating as initial setup."
              export SETUP_MODE="initial_setup"
            else
              echo "From: ${{ vars.JFROG_URL }}"
              echo "To: ${{ github.event.inputs.jpd_host }}"
            fi
            echo ""
          fi

          set -o pipefail
          CONTINUE_ON_AUTH_FAILURE=1 ./.github/scripts/setup/switch_jfrog_platform.sh 2>&1 | tee "$LOG_FILE"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Uploading full log as artifact" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload switch log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: switch-platform.log
          path: switch-platform.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Append log tail to summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“‹ Switch Platform Log Details" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f "switch-platform.log" ]]; then
            tail -n 200 "switch-platform.log" >> "$GITHUB_STEP_SUMMARY" || true
          fi
          
      - name: Validate New Platform
        run: |
          export NEW_JFROG_URL='${{ github.event.inputs.jpd_host }}'
          if [[ -n "${{ github.event.inputs.admin_token }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ github.event.inputs.admin_token }}'
          elif [[ -n "${{ secrets.JFROG_ADMIN_TOKEN }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ secrets.JFROG_ADMIN_TOKEN }}'
          else
            echo "âŒ No JFROG_ADMIN_TOKEN found in secrets or workflow inputs"
            exit 1
          fi
          echo "ðŸ” Validating new platform connectivity..."
          
          if curl -s --fail --header "Authorization: Bearer $NEW_JFROG_ADMIN_TOKEN" \
              "${NEW_JFROG_URL}/artifactory/api/system/ping" > /dev/null; then
            echo "âœ… New platform validation successful"
          else
            echo "âŒ New platform validation failed"
            exit 1
          fi
          
          echo ""
          echo "ðŸŽ¯ Platform Switch Summary:"
          echo "================================"
          echo "âœ… Host validation: Passed"
          echo "âœ… Connectivity test: Passed" 
          echo "âœ… Service availability: Verified"
          echo "âœ… All repositories updated: Confirmed"
          echo ""
          echo "ðŸš€ BookVerse is now configured for the new platform!"

      - name: Update Kubernetes Cluster Registry
        if: github.event.inputs.update_k8s == 'true'
        run: |
          echo "ðŸ”§ Updating Kubernetes cluster registry configuration..."
          echo ""
          
          if ! command -v kubectl >/dev/null 2>&1; then
            echo "âŒ kubectl not found. Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          
          if ! kubectl cluster-info >/dev/null 2>&1; then
            echo "âŒ Cannot connect to Kubernetes cluster"
            echo "   Make sure your cluster is accessible and kubeconfig is configured"
            echo "   Skipping K8s update - you'll need to update manually"
            exit 0
          fi
          
          export NEW_JFROG_URL='${{ github.event.inputs.jpd_host }}'
          if [[ -n "${{ github.event.inputs.admin_token }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ github.event.inputs.admin_token }}'
          elif [[ -n "${{ secrets.JFROG_ADMIN_TOKEN }}" ]]; then
            export NEW_JFROG_ADMIN_TOKEN='${{ secrets.JFROG_ADMIN_TOKEN }}'
          else
            echo "âŒ No JFROG_ADMIN_TOKEN found in secrets or workflow inputs"
            exit 1
          fi
          
          if ./scripts/k8s/update-registry.sh --restart-deployments; then
            echo ""
            echo "âœ… Kubernetes cluster updated successfully!"
            echo "   - Registry secret updated with new platform credentials"
            echo "   - Deployments restarted to pull from new registry"
          else
            echo ""
            echo "âš ï¸  Kubernetes update failed - you'll need to update manually"
            echo "   See the manual update instructions in the documentation"
          fi

      - name: ðŸ“‹ Switch Platform Summary
        if: always()
        run: |
          echo "## ðŸ”„ Platform Switch Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Logs: see artifact 'switch-platform.log' (if uploaded)" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Platform switch completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **BookVerse is now configured for the new platform**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            SETUP_MODE="${{ github.event.inputs.setup_mode }}"
            if [[ "$SETUP_MODE" == "initial_setup" ]]; then
              echo "### âœ… Initial Setup Details:" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸŽ¯ **Platform**: \`${{ github.event.inputs.jpd_host }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… Migration Details:" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ”— **From**: \`${{ vars.JFROG_URL }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸŽ¯ **To**: \`${{ github.event.inputs.jpd_host }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- ðŸ“¦ **Updated repositories**: All BookVerse service repositories" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” **Environment variables**: JFROG_URL, DOCKER_REGISTRY updated" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Validation**: New platform connectivity confirmed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            SETUP_MODE="${{ github.event.inputs.setup_mode }}"
            if [[ "$SETUP_MODE" == "initial_setup" ]]; then
              echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
              echo "1. ðŸ—ï¸ **Run Setup Platform workflow** to create JFrog infrastructure (projects, repos, OIDC)" >> $GITHUB_STEP_SUMMARY
              echo "2. ðŸ§ª **Test CI/CD workflows** to verify integration" >> $GITHUB_STEP_SUMMARY
              echo "3. ðŸ” **Verify repository configurations** are correct" >> $GITHUB_STEP_SUMMARY
              echo "4. âš™ï¸ **Check evidence keys** were generated and distributed" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
              echo "1. ðŸ—ï¸ **Run Setup Platform workflow** to initialize the new environment" >> $GITHUB_STEP_SUMMARY
              echo "2. ðŸ§ª **Test CI/CD workflows** to verify integration" >> $GITHUB_STEP_SUMMARY
              echo "3. ðŸ” **Check service repositories** for updated configurations" >> $GITHUB_STEP_SUMMARY
              echo "4. âš™ï¸ **Verify platform-specific settings** (OIDC, webhooks, etc.)" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ github.event.inputs.update_k8s }}" != "true" ]]; then
              echo "5. ðŸ”§ **Update Kubernetes cluster** manually (see documentation)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Platform switch failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Check the logs above for error details**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Common Issues:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” **Authentication failed** with new platform" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŒ **Network connectivity** to new platform" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ **Invalid admin token** or insufficient permissions" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ **Incorrect platform URL** format" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš« **GitHub API rate limits** or token issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… **Verify platform URL** (format: https://hostname.jfrog.io)" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ” **Check admin token** has proper permissions" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸŒ **Test platform connectivity** manually" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ“‹ **Review GitHub token** scopes and permissions" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ”„ **Retry with corrected inputs** if needed" >> $GITHUB_STEP_SUMMARY
          fi
